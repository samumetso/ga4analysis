#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Hotel Haven - Ev√§stehallintamuutosten Vaikutusanalyysi
Analysoi kes√§kuun 13-15 p√§iv√§n liikenteen pudotusta
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import matplotlib.pyplot as plt

def get_daily_data():
    """Palauta p√§ivitt√§inen data kes√§kuun 10-20 p√§iv√§lt√§"""
    
    # Oikea GA4-data
    daily_data = {
        'date': ['2025-06-10', '2025-06-11', '2025-06-12', '2025-06-13', 
                 '2025-06-14', '2025-06-15', '2025-06-16', '2025-06-17',
                 '2025-06-18', '2025-06-19', '2025-06-20'],
        'sessions': [1627, 1744, 1221, 929, 703, 619, 638, 583, 507, 488, 454],
        'users': [1430, 1557, 1068, 795, 579, 521, 546, 496, 436, 416, 369],
        'new_users': [1188, 1245, 844, 578, 415, 384, 400, 354, 325, 306, 285],
        'pageviews': [6439, 6940, 4224, 3008, 1985, 1948, 2314, 1839, 1639, 1575, 1433],
        'conversions': [48, 61, 35, 24, 18, 17, 22, 25, 16, 23, 18],
        'bounce_rate': [0.2145, 0.1795, 0.2891, 0.3057, 0.3229, 0.2827, 0.2555, 0.2779, 0.2781, 0.2889, 0.3502],
        'avg_session_duration': [159.2, 151.4, 152.7, 168.8, 125.8, 147.5, 198.2, 239.5, 173.9, 322.9, 178.7]
    }
    
    return pd.DataFrame(daily_data)

def get_channel_data():
    """Palauta kanavittainen data ennen ja j√§lkeen muutoksen"""
    
    # Aggregoidaan kanavakohtainen data
    channel_before = {  # 10-12 kes√§kuuta keskiarvo
        'Organic Search': {'sessions': 337, 'users': 284, 'pageviews': 1472},
        'Paid Search': {'sessions': 240, 'users': 201, 'pageviews': 1430},
        'Paid Social': {'sessions': 426, 'users': 408, 'pageviews': 855},
        'Direct': {'sessions': 162, 'users': 146, 'pageviews': 524},
        'Referral': {'sessions': 212, 'users': 189, 'pageviews': 795},
        'Email': {'sessions': 57, 'users': 53, 'pageviews': 169},
        'Cross-network': {'sessions': 51, 'users': 47, 'pageviews': 130},
        'Organic Social': {'sessions': 25, 'users': 23, 'pageviews': 78}
    }
    
    channel_after = {  # 13-15 kes√§kuuta keskiarvo
        'Organic Search': {'sessions': 207, 'users': 167, 'pageviews': 716},
        'Paid Search': {'sessions': 141, 'users': 121, 'pageviews': 618},
        'Paid Social': {'sessions': 161, 'users': 158, 'pageviews': 346},
        'Direct': {'sessions': 96, 'users': 79, 'pageviews': 324},
        'Referral': {'sessions': 62, 'users': 53, 'pageviews': 184},
        'Email': {'sessions': 16, 'users': 11, 'pageviews': 39},
        'Cross-network': {'sessions': 11, 'users': 11, 'pageviews': 24},
        'Organic Social': {'sessions': 12, 'users': 11, 'pageviews': 27}
    }
    
    return channel_before, channel_after

def analyze_traffic_drop():
    """Analysoi liikenteen pudotus"""
    
    df = get_daily_data()
    
    print("üîç HOTEL HAVEN - EV√ÑSTEHALLINTAMUUTOSTEN VAIKUTUSANALYYSI")
    print("=" * 80)
    print("Kes√§kuun 13-15 p√§iv√§n liikenteen pudotuksen syiden selvitt√§minen")
    print("=" * 80)
    print()
    
    # M√§√§rit√§ ennen/j√§lkeen ajanjaksot
    before_period = df[df['date'].isin(['2025-06-10', '2025-06-11', '2025-06-12'])]
    change_period = df[df['date'].isin(['2025-06-13', '2025-06-14', '2025-06-15'])]
    after_period = df[df['date'].isin(['2025-06-16', '2025-06-17', '2025-06-18', '2025-06-19', '2025-06-20'])]
    
    # Laske keskiarvot
    before_avg = before_period[['sessions', 'users', 'pageviews', 'conversions']].mean()
    change_avg = change_period[['sessions', 'users', 'pageviews', 'conversions']].mean()
    after_avg = after_period[['sessions', 'users', 'pageviews', 'conversions']].mean()
    
    print("üìä P√ÑIVITT√ÑINEN LIIKENNE - ENNEN, AIKANA JA J√ÑLKEEN")
    print("-" * 60)
    print(f"{'Jakso':<20} {'Istunnot':<10} {'K√§ytt√§j√§t':<10} {'Sivun√§yt√∂t':<12} {'Konversiot'}")
    print("-" * 60)
    print(f"{'Ennen (10-12.6)':<20} {before_avg['sessions']:<10.0f} {before_avg['users']:<10.0f} {before_avg['pageviews']:<12.0f} {before_avg['conversions']:.0f}")
    print(f"{'Muutos (13-15.6)':<20} {change_avg['sessions']:<10.0f} {change_avg['users']:<10.0f} {change_avg['pageviews']:<12.0f} {change_avg['conversions']:.0f}")
    print(f"{'J√§lkeen (16-20.6)':<20} {after_avg['sessions']:<10.0f} {after_avg['users']:<10.0f} {after_avg['pageviews']:<12.0f} {after_avg['conversions']:.0f}")
    print()
    
    # Laske muutosprosentit
    sessions_drop = ((change_avg['sessions'] - before_avg['sessions']) / before_avg['sessions']) * 100
    users_drop = ((change_avg['users'] - before_avg['users']) / before_avg['users']) * 100
    pageviews_drop = ((change_avg['pageviews'] - before_avg['pageviews']) / before_avg['pageviews']) * 100
    conversions_drop = ((change_avg['conversions'] - before_avg['conversions']) / before_avg['conversions']) * 100
    
    print("üìâ MUUTOKSET ENNEN ‚Üí MUUTOSJAKSO")
    print("-" * 40)
    print(f"Istunnot: {sessions_drop:+.1f}%")
    print(f"K√§ytt√§j√§t: {users_drop:+.1f}%")
    print(f"Sivun√§yt√∂t: {pageviews_drop:+.1f}%")
    print(f"Konversiot: {conversions_drop:+.1f}%")
    print()
    
    # Toipumisanalyysi
    recovery_sessions = ((after_avg['sessions'] - change_avg['sessions']) / change_avg['sessions']) * 100
    recovery_users = ((after_avg['users'] - change_avg['users']) / change_avg['users']) * 100
    
    print("üîÑ TOIPUMINEN MUUTOSJAKSO ‚Üí J√ÑLKEEN")
    print("-" * 40)
    print(f"Istunnot: {recovery_sessions:+.1f}%")
    print(f"K√§ytt√§j√§t: {recovery_users:+.1f}%")
    print()
    
    return before_avg, change_avg, after_avg

def analyze_channel_impact():
    """Analysoi kanavittainen vaikutus"""
    
    channel_before, channel_after = get_channel_data()
    
    print("üì∫ KANAVITTAINEN VAIKUTUSANALYYSI")
    print("=" * 80)
    print()
    
    print(f"{'Kanava':<20} {'Ennen':<15} {'J√§lkeen':<15} {'Muutos':<12} {'Vaikutus'}")
    print("-" * 80)
    
    channel_changes = {}
    
    for channel in channel_before.keys():
        before_sessions = channel_before[channel]['sessions']
        after_sessions = channel_after.get(channel, {'sessions': 0})['sessions']
        
        if before_sessions > 0:
            change_pct = ((after_sessions - before_sessions) / before_sessions) * 100
            channel_changes[channel] = change_pct
            
            # M√§√§rit√§ vaikutuksen vakavuus
            if change_pct > -10:
                impact = "üü¢ Liev√§"
            elif change_pct > -30:
                impact = "üü° Kohtalainen"
            elif change_pct > -50:
                impact = "üü† Merkitt√§v√§"
            else:
                impact = "üî¥ Vakava"
            
            print(f"{channel:<20} {before_sessions:<15.0f} {after_sessions:<15.0f} {change_pct:>+7.1f}% {impact}")
    
    print()
    
    # J√§rjest√§ kanavat vaikutuksen mukaan
    sorted_channels = sorted(channel_changes.items(), key=lambda x: x[1])
    
    print("üéØ ENITEN K√ÑRSIV√ÑT KANAVAT:")
    print("-" * 40)
    for i, (channel, change) in enumerate(sorted_channels[:3], 1):
        print(f"{i}. {channel}: {change:+.1f}%")
    
    print()
    return channel_changes

def investigate_possible_causes():
    """Tutki mahdollisia syit√§"""
    
    print("üî¨ MAHDOLLISET SYYT LIIKENTEEN PUDOTUKSELLE")
    print("=" * 80)
    print()
    
    print("1. üç™ EV√ÑSTEHALLINTAMUUTOKSET (TODENN√ÑK√ñISIN SYY)")
    print("-" * 50)
    print("‚úÖ Vahvistettuja tekij√∂it√§:")
    print("   ‚Ä¢ Ev√§stehallinta (CookiePro) k√§ytt√∂√∂notettu 13.6.2025")
    print("   ‚Ä¢ Muutos koskee useita hotellisivustoja")
    print("   ‚Ä¢ -50% pudotus rekister√∂idyss√§ liikenteess√§")
    print()
    
    print("üîç Mahdolliset tekniset ongelmat:")
    print("   ‚Ä¢ GA4 tracking code latautuu vasta ev√§stehyv√§ksynn√§n j√§lkeen")
    print("   ‚Ä¢ Ev√§stekielto est√§√§ GA4:n kokonaan (ei vain rajoita)")
    print("   ‚Ä¢ Virheellinen implementointi - tracking katkeaa")
    print("   ‚Ä¢ Server-side tracking puuttuu")
    print("   ‚Ä¢ Consent mode v2 ei ole k√§yt√∂ss√§")
    print()
    
    print("2. üö´ EV√ÑSTEKIELT√ÑYTYMISTEN VAIKUTUS")
    print("-" * 50)
    print("üìä Arvioitu vaikutus:")
    print("   ‚Ä¢ Ilmoitettu ev√§stehyv√§ksynn√§n vaikutus: <20%")
    print("   ‚Ä¢ Todellinen liikenteen pudotus: ~50%")
    print("   ‚Ä¢ Ero: ~30% = tekninen ongelma")
    print()
    
    print("3. üîß MUUT MAHDOLLISET SYYT")
    print("-" * 50)
    print("‚ùì Tarkistettavat tekij√§t:")
    print("   ‚Ä¢ Sivuston suorituskyky (latausnopeus)")
    print("   ‚Ä¢ CDN tai hosting-ongelmat")
    print("   ‚Ä¢ JavaScript-virheet")
    print("   ‚Ä¢ Mobiiliyhteensopivuus")
    print("   ‚Ä¢ SEO-muutokset")
    print("   ‚Ä¢ Kilpailijat tai markkinatilanne")
    print()

def create_investigation_checklist():
    """Luo tutkimuslista ongelman ratkaisemiseksi"""
    
    print("‚úÖ TUTKIMUSSUUNNITELMA - TOIMENPIDELISTA")
    print("=" * 80)
    print()
    
    print("üî• V√ÑLITT√ñM√ÑT TOIMENPITEET (1-2 p√§iv√§√§)")
    print("-" * 50)
    print("1. üç™ EV√ÑSTEHALLINTA - TEKNINEN TARKISTUS")
    print("   ‚ñ° Tarkista GA4 tracking code -implementointi")
    print("   ‚ñ° Varmista ett√§ GA4 latautuu my√∂s ilman ev√§stehyv√§ksynt√§√§")
    print("   ‚ñ° Testaa Consent Mode v2 k√§ytt√∂√∂notto")
    print("   ‚ñ° Tarkista CookiePro-asetukset")
    print("   ‚ñ° Vertaile muiden hotellien implementointia")
    print()
    
    print("2. üìä DATAN TARKISTUS")
    print("   ‚ñ° Tarkista Google Tag Manager -asetukset")
    print("   ‚ñ° Vertaile GA4 vs. server-side analytics")
    print("   ‚ñ° Analysoi Real-time reports GA4:ss√§")
    print("   ‚ñ° Tarkista Debug View -data")
    print("   ‚ñ° Vertaile muiden mittausty√∂kalujen dataa")
    print()
    
    print("üîç SYVEMPI ANALYYSI (3-7 p√§iv√§√§)")
    print("-" * 50)
    print("3. üß™ A/B TESTAUS")
    print("   ‚ñ° Testaa sivusto ilman ev√§stehallintaa")
    print("   ‚ñ° Vertaile eri ev√§stehallinta-asetuksia")
    print("   ‚ñ° Testaa eri selaimilla ja laitteilla")
    print("   ‚ñ° Analysoi k√§ytt√§j√§polkuja")
    print()
    
    print("4. üìà KANAVITTAINEN ANALYYSI")
    print("   ‚ñ° Analysoi orgaanisen haun muutokset")
    print("   ‚ñ° Tarkista maksetun mainonnan suorituskyky")
    print("   ‚ñ° Tutki sosiaalisen median liikenteen muutokset")
    print("   ‚ñ° Analysoi suoran liikenteen kehitys")
    print()
    
    print("üí° RATKAISUVAIHTOEHDOT")
    print("-" * 50)
    print("5. üîß TEKNISEN TOTEUTUKSEN KORJAUS")
    print("   ‚ñ° K√§ytt√∂√∂nota Consent Mode v2")
    print("   ‚ñ° Implementoi server-side tracking")
    print("   ‚ñ° Optimoi ev√§stehallinta-asetukset")
    print("   ‚ñ° Lis√§√§ cookieless tracking")
    print()
    
    print("6. üìä SEURANNAN PARANTAMINEN")
    print("   ‚ñ° Lis√§√§ ev√§stehyv√§ksynt√§-seuranta")
    print("   ‚ñ° Implementoi enhanced e-commerce tracking")
    print("   ‚ñ° K√§ytt√∂√∂nota data-driven attribution")
    print("   ‚ñ° Lis√§√§ cross-domain tracking")
    print()

def create_consent_analysis():
    """Analysoi ev√§stehyv√§ksynn√§n vaikutusta"""
    
    print("üç™ EV√ÑSTEHYV√ÑKSYNN√ÑN VAIKUTUSANALYYSI")
    print("=" * 80)
    print()
    
    print("üìä TEOREETTISET LASKELMAT:")
    print("-" * 40)
    
    # Oletetaan seuraavat luvut
    total_visitors_before = 1531  # Keskiarvo ennen muutosta
    total_visitors_after = 750    # Keskiarvo muutoksen aikana
    reported_consent_rate = 0.8   # 80% hyv√§ksyy ev√§steet (oletus)
    actual_drop = ((total_visitors_after - total_visitors_before) / total_visitors_before) * 100
    
    print(f"K√§vij√§t ennen muutosta: {total_visitors_before:,.0f}")
    print(f"K√§vij√§t muutoksen j√§lkeen: {total_visitors_after:,.0f}")
    print(f"Todellinen pudotus: {actual_drop:.1f}%")
    print()
    
    print("üßÆ SKENAARIOANALYYSI:")
    print("-" * 40)
    
    # Eri ev√§stehyv√§ksynt√§asteet
    consent_rates = [0.5, 0.6, 0.7, 0.8, 0.9]
    
    print(f"{'Hyv√§ksynt√§-%':<12} {'Odotettu liikenne':<18} {'Tekninen h√§vi√∂':<15} {'Selitys'}")
    print("-" * 65)
    
    for rate in consent_rates:
        expected_traffic = total_visitors_before * rate
        technical_loss = total_visitors_after - expected_traffic
        technical_loss_pct = (technical_loss / total_visitors_before) * 100
        
        if abs(technical_loss_pct) < 5:
            explanation = "‚úÖ Selittyy hyv√§ksynn√§ll√§"
        elif technical_loss_pct < -10:
            explanation = "üî¥ Tekninen ongelma"
        else:
            explanation = "üü° Osittain tekninen"
        
        print(f"{rate*100:>8.0f}%     {expected_traffic:>12.0f}        {technical_loss_pct:>+8.1f}%      {explanation}")
    
    print()
    print("üí° JOHTOP√Ñ√ÑT√ñS:")
    print("Jos ev√§stehyv√§ksynt√§aste on 80%, tekninen h√§vi√∂ on noin -20%")
    print("T√§m√§ viittaa implementointiongelmaan ev√§stehallinnassa.")
    print()

if __name__ == "__main__":
    # Suorita analyysi
    before_avg, change_avg, after_avg = analyze_traffic_drop()
    channel_changes = analyze_channel_impact()
    investigate_possible_causes()
    create_consent_analysis()
    create_investigation_checklist()
    
    print("üéØ YHTEENVETO JA SUOSITUKSET")
    print("=" * 80)
    print()
    print("üî¥ ONGELMA: ~50% liikenteen pudotus ev√§stehallintamuutosten j√§lkeen")
    print("üîç TODENN√ÑK√ñINEN SYY: Tekninen implementointiongelma")
    print("‚ö° V√ÑLITT√ñM√ÑT TOIMET: GA4 tracking -korjaus ja Consent Mode v2")
    print("üìà ODOTETTU PARANNUS: 20-30% liikenteen palautuminen")
    print()
    print("üìû SUOSITUS: Ota yhteytt√§ CookiePro-tukeen ja GA4-asiantuntijaan!")
